# 画像自動収集プログラム 要件定義

## 1. 概要
指定したWebページから画像を自動収集し、ローカルに保存する。ページ内のリンクをたどり、再帰的に画像収集を行う。通信はTorプロキシ経由で行う。

### 本ドキュメントで対象とするサイトの前提（スコープ明確化）
以下のような「画像ファイルの直接URLに通常のHTTPアクセス（requests等）で到達できない / 到達しても403, 認可エラー, blob: などで取得不能」な構成のみを対象とする。
対象例:
- img要素の src が blob: / data:image/ / 動的にJSで後挿入される
- 画像URLへ直接GETすると 403 / 401 / 404 / 空レスポンス（Referer / Cookie 必須）
- 署名付き・短期期限付きURLでページレンダリング中にのみ有効（外部再取得不可）
- canvas 描画のみで <img> タグ自体が無い

スコープ外（本要件では扱わない）:
- 静的にHTMLに埋め込まれた通常の http(s) 画像URLへ直接アクセス可能なサイト
- 通常のダウンロードで十分な構成（main.py方式で完結するもの）

この前提より、従来の "requests + BeautifulSoup" 方式では取得不能なため、ブラウザレンダリング環境を介する手段（Selenium + JS / ネットワークインターセプト）を基本方針とする。

## 2. 要件

### 2.1 画像収集
- 指定URLのWebページから画像を収集し、ローカルに保存する。
- 画像の幅が300px以上、かつ高さが250px以上の画像のみ保存対象とする。
　→理由：ページのヘッダーやアイコン等を保存対象から除外するため
　→補足：
　　・画像サイズ以外にも、以下のような方法で不要画像を除外することが可能。
　　　- ファイルサイズ（例：10KB未満は除外）
　　　- アスペクト比（横長・縦長すぎる画像を除外）
　　　- ファイル名やURLパターン（logo, icon, banner等を含むものを除外）
　　　- HTMLのクラス名やID属性（例：class="logo"やid="header"等を除外）
　　　- ページ上の表示位置（ページ上部や下部の画像を除外）
　　・要件や運用方針に応じて、これらの手法を組み合わせて柔軟に対応可能。
- base64形式（data:image/）の画像はスキップする。
　→理由：requests.get()でbase64画像（data:image/）を取得しようとするとエラーになるため、後続処理でエラーを回避する目的でスキップしている。
　　（必要に応じてbase64画像をデコードして保存する方法もあるが、現状はスキップする方針とする）

### 2.2 通信経路
- すべての通信はTorプロキシ（socks5h://127.0.0.1:9050）を経由する。

### 2.3 エラー処理
- 画像取得時に403エラーが発生した場合、そのページの処理を中断する。

### 2.4 ページ遷移
- ページ内のリンク（aタグ）から画像ファイルでないリンクを抽出し、ランダムで1つ選択して次ページとする。
- 次ページが存在する限り、同じ処理を再帰的に繰り返す。

### 2.5 保存先
- 画像は「downloaded_images/ドメイン名」配下に保存する。

## 3. 機能一覧
1. 画像URLの抽出（imgタグのsrc属性を絶対URL化）
2. 画像のダウンロードと保存
3. 画像サイズの判定
4. 次ページURLの抽出と遷移
5. 再帰的な処理
6. Torプロキシの利用

## 4. その他
- Selenium版ではrequestsやPILは使わず、Seleniumのみで画像取得・保存を行う。
- Windows環境ではgeckodriver.exeのパス指定が必要。

### 動的なWebページ操作の必要な理由
- 必要なケース：
	- ダウンロード対象の画像URLにアクセスできない場合
 	- 画像が blob: / data: / canvas / JS遅延挿入 など直接参照不能形式の場合
 	- Referer / Cookie / 動的トークン付与がないと 403 になる場合

### 直接アクセス禁止サイト向け 画像取得方式方針
1. JS経由抽出: <img> / canvas 要素を列挙し、`naturalWidth`/`naturalHeight` でサイズ判定。blob/canvas は `toDataURL()` でBase64取得しデコード保存。data:image/ はそのままデコード。
2. 元形式保持が必要な場合: selenium-wire もしくは Chrome DevTools Protocol(Network.getResponseBody) によるレスポンスバイナリ取得を拡張実装（オプション）。
3. 403/認可対策: SeleniumセッションCookieとヘッダ(Referer, UA)を同期し、必要時に requests セッションへ移植。直接取得不能な場合は 1 のレンダリング後データ取得へフォールバック。
4. メタ保持: 保存時に JSON ログへ {original_src, method(dataURL|network|canvas), width, height, stored_path} を記録し再現性確保。
5. 非対応ケース: DRM保護 / 暗号化ストリーム（動画セグメント）など純画像以外は除外。
